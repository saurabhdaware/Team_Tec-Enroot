<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3pro.css">
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.5.min.js"></script>
    </head>
    <body>
        <div class="w3-container">
            <div class="w3-row">
                <div class="w3-half">
                    <video autoplay></video>
                </div>
                <div class="w3-half">
                </div>

            </div>
        </div>
        <br>
        <button onclick="snapshot();">Click image</button>
        <br>
        <canvas id="myCanvas" width="400" height="350"></canvas>  
        <script>
        const node_server = 'https://smart-traffic-signal.herokuapp.com';

        const constraints = {
            video: (false)?true:{
                facingMode:{exact:"environment"}
            }
        };

        const video = document.querySelector('video');
        const canvas = document.getElementById('myCanvas');
        let ctx = canvas.getContext('2d');
        
        navigator.mediaDevices.getUserMedia(constraints)
        .then((stream) => {video.srcObject = stream});


        function snapshot() {
            // Draws current image from the video element into the canvas
            ctx.drawImage(video, 0,0, canvas.width, canvas.height);
            let image64 = canvas.toDataURL('image/jpeg',1.0);
            let dataimage = dataURLtoFile(image64,'something.jpg');
            uploadImage(dataimage);
        }

        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }

        function uploadImage(data){
            let formdata = new FormData();
            formdata.append('dataImage',data)
            axios.post(`${node_server}/upload`,formdata,{
                headers:{
                    'Content-Type':'multipart/form-data'
                }
            }).then(console.log)
        }


        var pubnub = new PubNub({
            subscribe_key: 'sub-c-d4d3783e-c59b-11e8-a415-1a3a09e2960b',
            publish_key: 'pub-c-7575af19-80c3-444b-a9d1-9af723c5cb1e'
        }); // replace this line with your pubnub settings, You can find them on pubnub docs

        pubnub.subscribe({
            channels: ['smart-traffic-change-signal']
        });

        pubnub.addListener({
            message: function (m) {
                if(m.message.signal) console.log(m.message.signal);
            }
        })
        </script>
    </body>
</html>



